<?xml version="1.0" encoding="UTF-8"?>
<CLISH_MODULE xmlns="http://clish.sourceforge.net/XMLSchema" 
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
 xsi:schemaLocation="http://clish.sourceforge.net/XMLSchema
                     http://clish.sourceforge.net/XMLSchema/clish.xsd">
	<!--=======================================================-->

<VIEW name="ping-view">

<!-- UTILS PROCESSING -->



<!-- COMMAND CONTAINERS -->

<COMMAND name="notify"  help="Notify Services" interrupt="true" />
<COMMAND name="notify siptrace"  help="SIP Trace Element" interrupt="true"/>


<!-- CURRENT LOGS TAIL -->

<COMMAND name="notify siptrace on screen" lock="false" help="Start SIP Tracer in Text Mode" interrupt="true">
                <ACTION>
					echo "Starting SIP Tracer... (CTRL-C to Stop)"
					cmd="ngrep -pql -W byline portrange 5060-5090"
					$cmd 
                </ACTION>
</COMMAND>

<COMMAND name="notify siptrace on" lock="false" help="Start SIP Tracer in Text Mode" interrupt="true">
                <ACTION>
				user=$(whoami)
				pid=$(ps aux | grep "ngrep" | grep "P $user" | grep -v "grep ngrep" | awk '$2!=0{print $2}')
				echo $pid
				if [ ! -z $pid ]; then
					echo "ERROR: SIP Trace to file is already runnnig for $user"
				else
					echo "Starting SIP Tracer $$ for $user..."
					ngrep -W byline portrange 5060-5090 -P $user > /tmp/siptrace$$.log &amp;
					echo "SIP Trace to file is runnnig (saving to: /tmp/siptrace$$.log)"
				fi
                </ACTION>
</COMMAND>
<COMMAND name="notify siptrace off" lock="false" help="Stop SIP Tracer in Text Mode" interrupt="true">
                <ACTION>
				user=$(whoami)
				pid=$(ps aux | grep "ngrep" | grep "P $user" | grep -v "grep ngrep" | awk '$2!=0{print $2}')
				echo $pid
				if [ ! -z $pid ]; then
					echo "Stopping SIP Tracer $pid..."
					kill $pid
					echo "Done."
				else
					echo "ERROR: SIP Trace is not runnnig."
				fi
                </ACTION>
</COMMAND>
<COMMAND name="notify siptrace kill all" lock="false" help="Kill ALL SIP Tracers" interrupt="true">
                <ACTION>
				killall ngrep
				rm -rf /tmp/siptrace*.pid
                </ACTION>
</COMMAND>
<COMMAND name="notify siptrace kill" lock="false" help="Kill SIP Tracers by PID" interrupt="true">
		 <PARAM name="npid"
                        optional="true"
                        help="Specify the PID to kill"
                        ptype="STRING"/>
                <ACTION>
			if test -n "${npid}"; then
				kill "${npid}"
			else 
			     pid=$(ps aux | grep "ngrep" | grep "P $user" | grep -v "grep ngrep" | awk '$2!=0{print $2}')
                                echo $pid
                                if [ ! -z $pid ]; then
					echo "Choose a PID to terminate:"
					echo $pid; echo
				else
					echo "No Tracers runnning."
				fi
			fi
                </ACTION>
</COMMAND>
<COMMAND name="notify siptrace list" lock="false" help="Kill ALL SIP Tracers" interrupt="true">
                <ACTION>
				 ps aux | grep "ngrep" | grep "P $user" | grep -v "grep ngrep" | awk '$2!=0{print $2}'
                </ACTION>
</COMMAND>

<COMMAND name="notify siptrace timed" lock="false" help="Start SIP Tracer with timer" interrupt="false" >
                 <PARAM name="tlimit"
                        optional="true"
                        default="10"
                        help="Specify the length of tracer is seconds"
                        ptype="STRING"/>
                <ACTION>
			user=$(whoami)
                        if test -n "${tlimit}"; then
					timeout "${tlimit}" ngrep -W byline portrange 5060-5090 -P $user > /tmp/siptrace_timed_$$.log &amp;
					echo "SIP Tracer timed capturing started for "${tlimit}" seconds, saving to: /tmp/siptrace_timed_$$.txt"
                        fi
                </ACTION>
</COMMAND>

<!-- END UTILS -->



</VIEW>

</CLISH_MODULE>
